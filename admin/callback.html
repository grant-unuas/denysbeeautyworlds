<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication - Deny's Beauty World</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="font-body bg-background-light min-h-screen flex items-center justify-center">
    <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
        <h2 class="text-xl font-semibold text-gray-800 mb-2">Authenticating...</h2>
        <p class="text-gray-600">Please wait while we verify your credentials</p>
        <div id="message" class="mt-4 p-3 rounded hidden"></div>
    </div>

    <script>
        const AUTHORIZED_EMAILS = [
            'grantunuas@gmail.com',
            'grantunua@gmail.com', 
            'grant.unua@gmail.com',
            'grantunua.s@gmail.com'
        ];
        
        const AUTH0_DOMAIN = 'dev-i5b08jbmyiyg4g8s.us.auth0.com';
        const AUTH0_CLIENT_ID = 'gtsyHwdN37OnhgHl7wypSrCLVpblQ9s6';
        
        let auth0Client;

        async function handleCallback() {
            try {
                auth0Client = await auth0.createAuth0Client({
                    domain: AUTH0_DOMAIN,
                    clientId: AUTH0_CLIENT_ID,
                    authorizationParams: {
                        redirect_uri: window.location.origin + '/admin/callback.html'
                    }
                });

                await auth0Client.handleRedirectCallback();
                const user = await auth0Client.getUser();

                if (!user?.email) {
                    throw new Error('No user email received');
                }

                const userEmail = user.email.toLowerCase().trim();
                if (!AUTHORIZED_EMAILS.includes(userEmail)) {
                    showMessage('Access denied - email not authorized', 'error');
                    setTimeout(() => window.location.href = 'login.html', 3000);
                    return;
                }

                const adminData = {
                    id: Date.now().toString(),
                    fullName: user.name || user.email,
                    email: user.email,
                    provider: 'google',
                    role: 'master',
                    createdAt: new Date().toISOString()
                };
                
                const admins = JSON.parse(localStorage.getItem('adminAccounts') || '[]');
                if (!admins.find(admin => admin.email === user.email)) {
                    admins.push(adminData);
                    localStorage.setItem('adminAccounts', JSON.stringify(admins));
                }

                sessionStorage.setItem('adminAuthenticated', 'true');
                sessionStorage.setItem('adminLoginTime', Date.now().toString());
                sessionStorage.setItem('adminData', JSON.stringify(adminData));
                
                window.location.href = 'dashboard.html';

            } catch (error) {
                showMessage('Authentication failed', 'error');
                setTimeout(() => window.location.href = 'login.html', 3000);
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            const bgColor = type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
            messageDiv.className = `mt-4 p-3 rounded border ${bgColor}`;
            messageDiv.textContent = message;
            messageDiv.classList.remove('hidden');
        }

        window.addEventListener('load', handleCallback);
    </script>
</body>
</html>
