<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication - Deny's Beauty World</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="font-body bg-background-light min-h-screen flex items-center justify-center">
    <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
        <h2 class="text-xl font-semibold text-gray-800 mb-2">Authenticating...</h2>
        <p class="text-gray-600">Please wait while we verify your credentials</p>
        <div id="message" class="mt-4 p-3 rounded hidden"></div>
    </div>

    <script>
        // Simple authorized emails check
        const AUTHORIZED_EMAILS = [
            'grantunuas@gmail.com',
            'grantunua@gmail.com',
            'grant.unua@gmail.com',
            'grantunua.s@gmail.com'
        ];
        
        const AUTH0_DOMAIN = 'dev-i5b08jbmyiyg4g8s.us.auth0.com';
        const AUTH0_CLIENT_ID = 'gtsyHwdN37OnhgHl7wypSrCLVpblQ9s6';
        
        let auth0Client;

        async function handleCallback() {
            try {
                showMessage('ðŸ”„ Processing authentication...', 'info');
                
                // Get base URL
                const baseUrl = window.location.hostname.includes('railway') 
                    ? 'https://denysbeautyworld.up.railway.app'
                    : window.location.origin;
                
                console.log('Using base URL:', baseUrl);
                
                // Initialize Auth0
                auth0Client = await auth0.createAuth0Client({
                    domain: AUTH0_DOMAIN,
                    clientId: AUTH0_CLIENT_ID,
                    authorizationParams: {
                        redirect_uri: baseUrl + '/admin/callback.html'
                    }
                });

                // Handle callback
                await auth0Client.handleRedirectCallback();
                
                // Get user
                const user = await auth0Client.getUser();
                console.log('User:', user);

                if (!user?.email) {
                    throw new Error('No user email received');
                }

                // Check authorization
                const userEmail = user.email.toLowerCase().trim();
                console.log('Checking email:', userEmail);
                console.log('Against:', AUTHORIZED_EMAILS);
                
                if (!AUTHORIZED_EMAILS.includes(userEmail)) {
                    showMessage(`âŒ Email "${userEmail}" not authorized`, 'error');
                    setTimeout(() => window.location.href = 'login.html', 3000);
                    return;
                }

                // Create admin data
                const adminData = {
                    id: Date.now().toString(),
                    fullName: user.name || user.email,
                    email: user.email,
                    provider: 'google',
                    role: 'master',
                    createdAt: new Date().toISOString()
                };
                
                // Save to localStorage
                const admins = JSON.parse(localStorage.getItem('adminAccounts') || '[]');
                const existingAdmin = admins.find(admin => admin.email === user.email);
                
                if (!existingAdmin) {
                    admins.push(adminData);
                    localStorage.setItem('adminAccounts', JSON.stringify(admins));
                }

                // Set session
                sessionStorage.setItem('adminAuthenticated', 'true');
                sessionStorage.setItem('adminLoginTime', Date.now().toString());
                sessionStorage.setItem('adminData', JSON.stringify(adminData));

                showMessage('âœ… Success! Redirecting to dashboard...', 'success');
                
                // Redirect to dashboard
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 500);

            } catch (error) {
                console.error('Callback error:', error);
                showMessage('âŒ Authentication failed: ' + error.message, 'error');
                setTimeout(() => window.location.href = 'login.html', 3000);
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            let bgColor, textColor;
            
            if (type === 'error') {
                bgColor = 'bg-red-100';
                textColor = 'text-red-700';
            } else if (type === 'success') {
                bgColor = 'bg-green-100';
                textColor = 'text-green-700';
            } else {
                bgColor = 'bg-blue-100';
                textColor = 'text-blue-700';
            }
            
            messageDiv.className = `mt-4 p-3 rounded border ${bgColor} ${textColor}`;
            messageDiv.textContent = message;
            messageDiv.classList.remove('hidden');
        }

        // Start the callback handling
        window.addEventListener('load', handleCallback);
    </script>
</body>
</html>
