<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication - Deny's Beauty World</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="font-body bg-background-light min-h-screen flex items-center justify-center">
    <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
        <h2 class="text-xl font-semibold text-gray-800 mb-2">Authenticating...</h2>
        <p class="text-gray-600">Please wait while we verify your credentials</p>
        <div id="message" class="mt-4 p-3 rounded hidden"></div>
    </div>

    <script>
        // Simple authorized emails check
        const AUTHORIZED_EMAILS = [
            'grantunuas@gmail.com',
            'grantunua@gmail.com',
            'grant.unua@gmail.com',
            'grantunua.s@gmail.com'
        ];
        
        const AUTH0_DOMAIN = 'dev-i5b08jbmyiyg4g8s.us.auth0.com';
        const AUTH0_CLIENT_ID = 'gtsyHwdN37OnhgHl7wypSrCLVpblQ9s6';
        
        let auth0Client;

        async function handleCallback() {
            showMessage('ðŸ”„ Starting authentication...', 'info');
            
            try {
                // Check if we have URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                console.log('URL params:', Object.fromEntries(urlParams));
                
                if (!urlParams.has('code') && !urlParams.has('error')) {
                    throw new Error('No authentication code or error in URL');
                }
                
                if (urlParams.has('error')) {
                    throw new Error('Auth0 error: ' + urlParams.get('error_description'));
                }
                
                showMessage('ðŸ”„ Initializing Auth0...', 'info');
                
                // Get base URL
                const baseUrl = window.location.hostname.includes('railway') 
                    ? 'https://denysbeautyworld.up.railway.app'
                    : window.location.origin;
                
                console.log('Base URL:', baseUrl);
                console.log('Current URL:', window.location.href);
                
                // Initialize Auth0
                auth0Client = await auth0.createAuth0Client({
                    domain: AUTH0_DOMAIN,
                    clientId: AUTH0_CLIENT_ID,
                    authorizationParams: {
                        redirect_uri: baseUrl + '/admin/callback.html'
                    }
                });
                
                console.log('Auth0 client created');
                showMessage('ðŸ”„ Processing callback...', 'info');

                // Handle callback
                const result = await auth0Client.handleRedirectCallback();
                console.log('Callback result:', result);
                
                showMessage('ðŸ”„ Getting user info...', 'info');
                
                // Get user
                const user = await auth0Client.getUser();
                console.log('User data:', user);

                if (!user) {
                    throw new Error('No user data received from Auth0');
                }
                
                if (!user.email) {
                    throw new Error('No email in user data');
                }

                // Check authorization
                const userEmail = user.email.toLowerCase().trim();
                console.log('User email:', userEmail);
                console.log('Authorized emails:', AUTHORIZED_EMAILS);
                
                if (!AUTHORIZED_EMAILS.includes(userEmail)) {
                    showMessage(`âŒ Email "${userEmail}" not in authorized list: ${AUTHORIZED_EMAILS.join(', ')}`, 'error');
                    setTimeout(() => window.location.href = 'login.html', 5000);
                    return;
                }

                showMessage('âœ… Email authorized! Creating session...', 'success');

                // Create admin data
                const adminData = {
                    id: Date.now().toString(),
                    fullName: user.name || user.email,
                    email: user.email,
                    provider: 'google',
                    role: 'master',
                    createdAt: new Date().toISOString()
                };
                
                console.log('Admin data:', adminData);
                
                // Save to localStorage
                const admins = JSON.parse(localStorage.getItem('adminAccounts') || '[]');
                const existingAdmin = admins.find(admin => admin.email === user.email);
                
                if (!existingAdmin) {
                    admins.push(adminData);
                    localStorage.setItem('adminAccounts', JSON.stringify(admins));
                    console.log('Admin account created');
                } else {
                    console.log('Using existing admin account');
                }

                // Set session
                sessionStorage.setItem('adminAuthenticated', 'true');
                sessionStorage.setItem('adminLoginTime', Date.now().toString());
                sessionStorage.setItem('adminData', JSON.stringify(adminData));
                
                console.log('Session data set');

                showMessage('âœ… Success! Redirecting to dashboard in 2 seconds...', 'success');
                
                // Redirect to dashboard
                setTimeout(() => {
                    console.log('Redirecting to dashboard...');
                    window.location.href = 'dashboard.html';
                }, 2000);

            } catch (error) {
                console.error('Full error object:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                let errorMsg = 'Unknown error';
                if (error.message) {
                    errorMsg = error.message;
                } else if (error.error_description) {
                    errorMsg = error.error_description;
                } else if (error.error) {
                    errorMsg = error.error;
                }
                
                showMessage('âŒ Error: ' + errorMsg, 'error');
                
                // Show detailed error for debugging
                setTimeout(() => {
                    showMessage('ðŸ” Check browser console (F12) for detailed error info. Redirecting to login...', 'info');
                }, 2000);
                
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 5000);
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            let bgColor, textColor;
            
            if (type === 'error') {
                bgColor = 'bg-red-100';
                textColor = 'text-red-700';
            } else if (type === 'success') {
                bgColor = 'bg-green-100';
                textColor = 'text-green-700';
            } else {
                bgColor = 'bg-blue-100';
                textColor = 'text-blue-700';
            }
            
            messageDiv.className = `mt-4 p-3 rounded border ${bgColor} ${textColor}`;
            messageDiv.textContent = message;
            messageDiv.classList.remove('hidden');
        }

        // Start the callback handling
        window.addEventListener('load', handleCallback);
    </script>
</body>
</html>
